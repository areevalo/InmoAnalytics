{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Listado de Propiedades</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h1 class="text-center">InmoAnalytics Madrid</h1>
    <hr>
    <h3 class="text-decoration-underline mb-4">Buscar Propiedades:</h3>
    <form method="get" class="row g-3">
        <div class="col-md-3" id="id_municipality">
            {{ filter.form.municipality.label_tag }}
            {{ filter.form.municipality }}
        </div>
        <div class="col-md-3" id="neighborhood-container">
            <label for="id_neighborhood">Barrio</label>
            <select class="form-select" id="id_neighborhood" name="neighborhood" disabled>
                <option>Introduce un municipio</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="price_range">Precio (€)</label>
            <div class="d-flex align-items-center">
                <input type="range" min="0" max="1000000" step="1000" id="price_min" name="price_min"
                       value="{{ request.GET.price_min|default:0 }}"
                       oninput="updatePriceVals()">
                <span class="mx-2" id="min_price_val">{{ request.GET.price_min|default:0 }}</span>
                <span> -   </span>
                <input type="range" min="0" max="1000000" step="1000" id="price_max" name="price_max"
                       value="{{ request.GET.price_max|default:1000000 }}"
                       oninput="updatePriceVals()">
                <span class="mx-2" id="max_price_val"></span>
            </div>
        </div>
        <div class="col-md-2">
            {{ filter.form.min_area.label_tag }}
            {{ filter.form.min_area }}
        </div>
        <div class="col-md-2">
            {{ filter.form.min_rooms.label_tag }}
            {{ filter.form.min_rooms }}
        </div>
        <div class="col-md-2">
            {{ filter.form.min_baths.label_tag }}
            {{ filter.form.min_baths }}
        </div>
        <div class="col-md-3">
            {{ filter.form.type_of_home.label_tag }}
            {{ filter.form.type_of_home }}
        </div>
        <div class="col-md-3">
            {{ filter.form.construction_type.label_tag }}
            {{ filter.form.construction_type }}
        </div>
        <div class="col-md-3">
            {{ filter.form.ownership_status.label_tag }}
            {{ filter.form.ownership_status }}
        </div>
        <div class="col-md-2">
            {{ filter.form.floor_level.label_tag }}
            {{ filter.form.floor_level }}
        </div>
        <div class="col-md-2">
            {{ filter.form.min_energy_calification.label_tag }}
            {{ filter.form.min_energy_calification }}
        </div>
        <div class="col-md-2">
            {{ filter.form.orientation.label_tag }}
            {{ filter.form.orientation }}
        </div>
        <div class="col-md-2">
            {{ filter.form.construction_year.label_tag }}
            {{ filter.form.construction_year }}
        </div>
        <div class="accordion mb-3" id="booleanFiltersAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header" id="headingBoolean">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoolean" aria-expanded="false" aria-controls="collapseBoolean">
                Características adicionales
              </button>
            </h2>
            <div id="collapseBoolean" class="accordion-collapse collapse" aria-labelledby="headingBoolean" data-bs-parent="#booleanFiltersAccordion">
              <div class="accordion-body">
                  <div class="row">
                    <div class="col-md-4">{{ filter.form.air_conditioning }} Aire acondicionado</div>
                    <div class="col-md-4">{{ filter.form.fitted_wardrobes }} Armarios empotrados</div>
                    <div class="col-md-4">{{ filter.form.elevator }} Ascensor</div>
                    <div class="col-md-4">{{ filter.form.balcony }} Balcón</div>
                    <div class="col-md-4">{{ filter.form.heating }} Calefacción</div>
                    <div class="col-md-4">{{ filter.form.garage }} Garaje</div>
                    <div class="col-md-4">{{ filter.form.garden }} Jardín</div>
                    <div class="col-md-4">{{ filter.form.pool }} Piscina</div>
                    <div class="col-md-4">{{ filter.form.underfloor_heating }} Suelo radiante</div>
                    <div class="col-md-4">{{ filter.form.terrace }} Terraza</div>
                    <div class="col-md-4">{{ filter.form.storage_room }} Trastero</div>
                  </div>
              </div>
            </div>
          </div>
        </div>
{#        <div class="col-md-2">#}
{#            <label for="min_rooms">Habitaciones</label>#}
{#            <select class="form-select" id="min_rooms" name="min_rooms">#}
{#                <option value="">Cualquiera</option>#}
{#                <option value="1" {% if request.GET.min_rooms == '1' %}selected{% endif %}>1+</option>#}
{#                <option value="2" {% if request.GET.min_rooms == '2' %}selected{% endif %}>2+</option>#}
{#                <option value="3" {% if request.GET.min_rooms == '3' %}selected{% endif %}>3+</option>#}
{#                <option value="4" {% if request.GET.min_rooms == '4' %}selected{% endif %}>4+</option>#}
{#                <option value="5" {% if request.GET.min_rooms == '5' %}selected{% endif %}>5+</option>#}
{#            </select>#}
{#        </div>#}
{#        <div class="col-md-2">#}
{#            <label for="min_bathrooms">Baños</label>#}
{#            <select class="form-select" id="min_bathrooms" name="min_bathrooms">#}
{#                <option value="">Cualquiera</option>#}
{#                <option value="1" {% if request.GET.min_bathrooms == '1' %}selected{% endif %}>1+</option>#}
{#                <option value="2" {% if request.GET.min_bathrooms == '2' %}selected{% endif %}>2+</option>#}
{#                <option value="3" {% if request.GET.min_bathrooms == '3' %}selected{% endif %}>3+</option>#}
{#                <option value="4" {% if request.GET.min_bathrooms == '4' %}selected{% endif %}>4+</option>#}
{#            </select>#}
{#        </div>#}
{#        <div class="col-md-6">#}
{#            <label for="year_range">Año de construcción</label>#}
{#            <div class="d-flex align-items-center">#}
{#                <input type="range" min="1850" max="2025" step="1" id="min_year" name="min_year"#}
{#                       value="{{ request.GET.min_year|default:1900 }}"#}
{#                       oninput="document.getElementById('min_year_val').innerText = this.value">#}
{#                <span class="mx-2" id="min_year_val">{{ request.GET.min_year|default:1900 }}</span>#}
{#                <span> - </span>#}
{#                <input type="range" min="1850" max="2025" step="1" id="max_year" name="max_year"#}
{#                       value="{{ request.GET.max_year|default:2024 }}"#}
{#                       oninput="document.getElementById('max_year_val').innerText = this.value">#}
{#                <span class="mx-2" id="max_year_val">{{ request.GET.max_year|default:2024 }}</span>#}
{#            </div>#}
{#        </div>#}
        <div class="col-12 mb-6">
            <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
    </form>
    <script>
        // Al cambiar el municipio, actualiza los barrios
        document.getElementById('id_municipality').addEventListener('change', function() {
            const municipio = this.querySelector('select, input').value;
            const barrio = document.getElementById('id_neighborhood');
            barrio.innerHTML = '';
            if (municipio) {
                fetch(`/ajax/get_neighborhoods/?municipality=${encodeURIComponent(municipio)}`)
                    .then(response => response.json())
                    .then(data => {
                        barrio.disabled = false;
                        barrio.innerHTML = '<option value="">Cualquiera</option>';
                        data.neighborhoods.forEach(function(n) {
                            barrio.innerHTML += `<option value="${n}">${n}</option>`;
                        });
                    });
            } else {
                barrio.disabled = true;
                barrio.innerHTML = '<option>Introduce un municipio</option>';
            }
        });
        // Actualiza los valores mostrados de los rangos de precio mínimo y máximo
        function updatePriceVals() {
            const max = 1000000;
            const priceMax = document.getElementById('price_max').value;
            document.getElementById('min_price_val').innerText = document.getElementById('price_min').value;
            document.getElementById('max_price_val').innerText = (parseInt(priceMax) === max) ? 'Sin límite' : priceMax;
        }
        // Inicializa los valores al cargar la página
        updatePriceVals();

        // Al enviar el formulario, si el valor es el máximo, vacía el campo
        document.querySelector('form').addEventListener('submit', function(e) {
            const max = 1000000;
            const priceMaxInput = document.getElementById('price_max');
            if (parseInt(priceMaxInput.value) === max) {
                priceMaxInput.removeAttribute('name');
            }
        });
    </script>
    <div class="alert alert-info mt-3" role="alert">
        Algunos datos adicionales solo están disponibles en la exportación a Excel.
        <a href="" class="btn btn-sm btn-outline-primary ms-2">Exportar a Excel</a>
{#        <a href="{% url 'export_properties_excel' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-primary ms-2">Exportar a Excel</a>#}
    </div>
    <hr>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Municipio</th>
{#                <th>Barrio</th>#}
                <th>Precio</th>
                <th>Tamaño</th>
                <th>Habitaciones</th>
                <th>Baños</th>
                <th>Ascensor</th>
                <th>Garaje</th>
                <th>Tipo vivienda</th>
                <th>Planta</th>
                <th>Tipo construcción</th>
{#                <th>Estado</th>#}
{#                <th>Año construcción</th>#}
                <th>URL</th>
            </tr>
        </thead>
        <tbody>
        {% for prop in properties %}
            <tr>
                <td>{{ prop.municipality|default:"Sin datos" }}</td>
{#                <td>{{ prop.neighborhood|default:"Sin datos" }}</td>#}
                <td>{{ prop.price|default:"Sin datos" }}</td>
                <td>{{ prop.area|default:"Sin datos" }}</td>
                <td>{{ prop.rooms|default:"Sin datos" }}</td>
                <td>{{ prop.baths|default:"Sin datos" }}</td>
                <td>{{ prop.elevator|default:"Sin datos" }}</td>
                <td>{{ prop.garage|default:"Sin datos" }}</td>
                <td>{{ prop.type_of_home|default:"Sin datos" }}</td>
                <td>{{ prop.floor|default:"Sin datos" }}</td>
                <td>{{ prop.is_new_home|default:"Sin datos" }}</td>
{#                <td>{{ prop.ownership_status|default:"Sin datos" }}</td>#}

{#                <td>#}
{#                    {% if prop.construction_year_min and prop.construction_year_max and prop.construction_year_min != prop.construction_year_max %}#}
{#                        {{ prop.construction_year_min }} - {{ prop.construction_year_max }}#}
{#                    {% elif prop.construction_year_min %}#}
{#                        {% if not prop.construction_year_max %}#}
{#                            &gt;{{ prop.construction_year_min }}#}
{#                        {% else %}#}
{#                            {{ prop.construction_year_min }}#}
{#                        {% endif %}#}
{#                    {% elif prop.construction_year_max %}#}
{#                        &lt;{{ prop.construction_year_max }}#}
{#                    {% else %}#}
{#                        Sin datos#}
{#                    {% endif %}#}
{#                </td>#}
                <td>
                    {% if prop.url %}
                        <a href="{{ prop.url }}" target="_blank">Ver</a>
                    {% else %}
                        Sin datos
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr>
                <td class="text-center table-warning fw-bold py-4" colspan="12">
                    No hay resultados. Introduce otros filtros
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <nav aria-label="Paginación">
      <ul class="pagination justify-content-center">
        {# Botón primera página #}
        <li class="page-item {% if page_obj.number == 1 %}active{% endif %}">
          <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page=1">1</a>
        </li>

        {# Separador si hay más de 4 páginas antes de la actual #}
        {% if page_obj.number > 4 %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}

        {# Páginas intermedias (máximo 2 antes y después de la actual) #}
        {% for num in page_obj.paginator.page_range %}
          {% if num > 1 and num < page_obj.paginator.num_pages and num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
              <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
            </li>
          {% endif %}
        {% endfor %}

        {# Separador si hay más de 3 páginas después de la actual #}
        {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
          <li class="page-item disabled"><span class="page-link">...</span></li>
        {% endif %}

        {# Botón última página (si hay más de una página) #}
        {% if page_obj.paginator.num_pages > 1 %}
          <li class="page-item {% if page_obj.number == page_obj.paginator.num_pages %}active{% endif %}">
            <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a>
          </li>
        {% endif %}
      </ul>
    </nav>
</div>
</body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</html>
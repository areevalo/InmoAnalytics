{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Listado de Propiedades</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
<div class="container mt-4">
    <h2>InmoAnalytics Madrid</h2>
    <h3>Buscar Propiedades</h3>
    <form method="get" class="row g-3">
        <div class="col-md-3" id="id_municipality">
            {{ filter.form.municipality.label_tag }}
            {{ filter.form.municipality }}
        </div>
        <div class="col-md-3" id="neighborhood-container">
            <label for="id_neighborhood">Barrio</label>
            <select class="form-select" id="id_neighborhood" name="neighborhood" {% if not request.GET.municipality %}disabled{% endif %}>
                {% if not request.GET.municipality %}
                    <option>Introduce un municipio</option>
                {% else %}
                    <option value="">Cualquiera</option>
                    {% for val, label in filter.form.fields.neighborhood.choices %}
                        <option value="{{ val }}" {% if request.GET.neighborhood == val %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                {% endif %}
            </select>
        </div>
        <script>
            // Habilita/deshabilita el campo barrio según el municipio seleccionado
            document.getElementById('id_municipality').addEventListener('change', function() {
                const barrio = document.getElementById('id_neighborhood');
                if (this.value) {
                    barrio.disabled = false;
                } else {
                    barrio.disabled = true;
                    barrio.innerHTML = '<option>Introduce un municipio</option>';
                }
            });
        </script>
        <div class="col-md-6">
            <label for="price_range">Precio (€)</label>
            <div class="d-flex align-items-center">
                <input type="range" min="0" max="1000000" step="1000" id="price_min" name="price_min"
                       value="{{ request.GET.price_min|default:0 }}"
                       oninput="updatePriceVals()">
                <span class="mx-2" id="min_price_val">{{ request.GET.price_min|default:0 }}</span>
                <span> - </span>
                <input type="range" min="0" max="1000000" step="1000" id="price_max" name="price_max"
                       value="{{ request.GET.price_max|default:1000000 }}"
                       oninput="updatePriceVals()">
                <span class="mx-2" id="max_price_val"></span>
            </div>
        </div>
        <script>
            function updatePriceVals() {
                const max = 1000000;
                const priceMax = document.getElementById('price_max').value;
                document.getElementById('min_price_val').innerText = document.getElementById('price_min').value;
                document.getElementById('max_price_val').innerText = (parseInt(priceMax) === max) ? 'Sin límite' : priceMax;
            }
            // Inicializa los valores al cargar la página
            updatePriceVals();

            // Al enviar el formulario, si el valor es el máximo, vacía el campo
            document.querySelector('form').addEventListener('submit', function(e) {
                const max = 1000000;
                const priceMaxInput = document.getElementById('price_max');
                if (parseInt(priceMaxInput.value) === max) {
                    priceMaxInput.removeAttribute('name');
                }
            });
        </script>
        <div class="col-md-2">
            <label for="min_area">Tamaño (m²)</label>
            <input type="number" class="form-control" id="min_area" name="min_area" placeholder="Mínimo"
                   value="{{ request.GET.min_area|default:0 }}">
        <div class="col-md-3">
            {{ filter.form.type_of_home.label_tag }}
            {{ filter.form.type_of_home }}
        </div>
        <div class="col-md-3">
            {{ filter.form.construction_type.label_tag }}
            {{ filter.form.construction_type }}
        </div>
        <div class="col-md-2">
            <label for="min_rooms">Habitaciones</label>
            <select class="form-select" id="min_rooms" name="min_rooms">
                <option value="">Cualquiera</option>
                <option value="1" {% if request.GET.min_rooms == '1' %}selected{% endif %}>1+</option>
                <option value="2" {% if request.GET.min_rooms == '2' %}selected{% endif %}>2+</option>
                <option value="3" {% if request.GET.min_rooms == '3' %}selected{% endif %}>3+</option>
                <option value="4" {% if request.GET.min_rooms == '4' %}selected{% endif %}>4+</option>
                <option value="5" {% if request.GET.min_rooms == '5' %}selected{% endif %}>5+</option>
            </select>
        </div>
        <div class="col-md-2">
            <label for="min_bathrooms">Baños</label>
            <select class="form-select" id="min_bathrooms" name="min_bathrooms">
                <option value="">Cualquiera</option>
                <option value="1" {% if request.GET.min_bathrooms == '1' %}selected{% endif %}>1+</option>
                <option value="2" {% if request.GET.min_bathrooms == '2' %}selected{% endif %}>2+</option>
                <option value="3" {% if request.GET.min_bathrooms == '3' %}selected{% endif %}>3+</option>
                <option value="4" {% if request.GET.min_bathrooms == '4' %}selected{% endif %}>4+</option>
            </select>
        </div>
{#        <div class="col-md-6">#}
{#            <label for="year_range">Año de construcción</label>#}
{#            <div class="d-flex align-items-center">#}
{#                <input type="range" min="1850" max="2025" step="1" id="min_year" name="min_year"#}
{#                       value="{{ request.GET.min_year|default:1900 }}"#}
{#                       oninput="document.getElementById('min_year_val').innerText = this.value">#}
{#                <span class="mx-2" id="min_year_val">{{ request.GET.min_year|default:1900 }}</span>#}
{#                <span> - </span>#}
{#                <input type="range" min="1850" max="2025" step="1" id="max_year" name="max_year"#}
{#                       value="{{ request.GET.max_year|default:2024 }}"#}
{#                       oninput="document.getElementById('max_year_val').innerText = this.value">#}
{#                <span class="mx-2" id="max_year_val">{{ request.GET.max_year|default:2024 }}</span>#}
{#            </div>#}
{#        </div>#}
        <div class="col-12">
            <button type="submit" class="btn btn-primary">Filtrar</button>
        </div>
    </form>
    <hr>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Municipio</th>
                <th>Barrio</th>
                <th>Precio</th>
                <th>Habitaciones</th>
                <th>Baños</th>
                <th>Tamaño</th>
{#                <th>Año construcción</th>#}
                <th>URL</th>
            </tr>
        </thead>
        <tbody>
        {% for prop in properties %}
            <tr>
                <td>{{ prop.municipality|default:"Sin datos" }}</td>
                <td>{{ prop.neighborhood|default:"Sin datos" }}</td>
                <td>{{ prop.price|default:"Sin datos" }}</td>
                <td>{{ prop.rooms|default:"Sin datos" }}</td>
                <td>{{ prop.baths|default:"Sin datos" }}</td>
                <td>{{ prop.area|default:"Sin datos" }}</td>
{#                <td>#}
{#                    {% if prop.construction_year_min and prop.construction_year_max and prop.construction_year_min != prop.construction_year_max %}#}
{#                        {{ prop.construction_year_min }} - {{ prop.construction_year_max }}#}
{#                    {% elif prop.construction_year_min %}#}
{#                        {% if not prop.construction_year_max %}#}
{#                            &gt;{{ prop.construction_year_min }}#}
{#                        {% else %}#}
{#                            {{ prop.construction_year_min }}#}
{#                        {% endif %}#}
{#                    {% elif prop.construction_year_max %}#}
{#                        &lt;{{ prop.construction_year_max }}#}
{#                    {% else %}#}
{#                        Sin datos#}
{#                    {% endif %}#}
{#                </td>#}
                <td>
                    {% if prop.url %}
                        <a href="{{ prop.url }}" target="_blank">Ver</a>
                    {% else %}
                        Sin datos
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="6">No hay resultados.</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
</body>
</html>